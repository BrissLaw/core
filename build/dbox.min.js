!function(t,a){"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a(t.dbox=t.dbox||{})}(this,function(t){"use strict";function a(t,a){var e=new cartodb.SQL({user:t.cartodb.user});e.execute(t.cartodb.sql).done(function(e){var n=e.rows;t.parser&&(n=e.rows.map(t.parser)),a(null,n)}).error(function(t){a(t,null)})}function e(t,a,e){e(null,t.map(a))}function n(t){var a=this;a._config=t,a._svg,a._margin,a._widht,a._height,a._tip=d3.tip().attr("class","d3-tip").html(a._config.data.tip),a.draw()}function r(t){return new n(arguments.length?t:null)}function s(t){var a=this;a._config=t,a._chart,a._scales={},a._axes={}}function c(t){return new s(arguments.length?t:null)}function i(t){var a=this;a._config=t,a._chart,a._scales={},a._axes={}}function o(t){return new i(arguments.length?t:null)}function l(t){var a=this;a._config=t,a._chart,a._scales={},a._axes={}}function d(t,a){var e={};return t.forEach(function(t){t.key===a&&(e=t)}),e}function u(t){return new l(arguments.length?t:null)}function _(t){var a=this;a._config=t.config,a._chart=t.chart,a._data=t.data,a._scales=t.scales}function f(t){return new _(arguments.length?t:null)}function g(t){var a=this;a._config=t.config,a._chart=t.chart,a._data=t.data,a._scales=t.scales}function x(t){return new g(arguments.length?t:null)}function h(t){var a=this;a._config=t.config,a._chart=t.chart,a._data=t.data,a._scales=t.scales}function y(t){return new h(arguments.length?t:null)}function p(t){var a=this;a._config=t.config,a._chart=t.chart,a._data=t.data,a._scales=t.scales}function v(t){return new p(arguments.length?t:null)}function m(t){var a=this;a._config=t,a._chart,a._scales={},a._axes={},a._averageLines=[],a.columns=null,a.lineAndCircles=null,a.quantilesAndCircles=null}function w(t){return new m(arguments.length?t:null)}n.prototype=r.prototype={dispatch:d3.dispatch("load","change"),draw:function(){var t=this;d3.select(t._config.bindTo).html(""),t._margin=t._config.size.margin,t._width=t._config.size.width-t._margin.left-t._margin.right,t._height=t._config.size.height-t._margin.top-t._margin.bottom,t._svg=d3.select(t._config.bindTo).append("svg").attr("width",t._width+t._margin.left+t._margin.right).attr("height",t._height+t._margin.top+t._margin.bottom).append("g").attr("transform","translate("+t._margin.left+","+t._margin.top+")").call(t._tip)},loadData:function(){var t=this;if(t._config.data.tsv)var n=d3.queue().defer(d3.tsv,t._config.data.tsv,t._config.data.parser);if(t._config.data.csv)var n=d3.queue().defer(d3.csv,t._config.data.csv,t._config.data.parser);if(t._config.data.raw)var n=d3.queue().defer(e,t._config.data.raw,t._config.data.parser);if(t._config.data.cartodb)var n=d3.queue().defer(a,t._config.data);return t._config.plotOptions&&t._config.plotOptions.bars&&t._config.plotOptions.bars.averageLines&&Array.isArray(t._config.plotOptions.bars.averageLines)&&t._config.plotOptions.bars.averageLines.length>0&&t._config.plotOptions.bars.averageLines.forEach(function(t){t.data.cartodb&&n.defer(a,t.data)}),n},setScales:function(){var t=this,a={};if(t._config.xAxis&&t._config.xAxis.scale)switch(t._config.xAxis.scale){case"linear":a.x=d3.scale.linear().range([0,t._width]);break;case"time":a.x=d3.time.scale().range([0,t._width]);break;case"ordinal":a.x=d3.scale.ordinal().rangeBands([0,t._width],.1);break;case"quantile":a.x=d3.scale.ordinal().rangeBands([0,t._width],.1),a.q=d3.scale.quantile().range(d3.range(t._config.xAxis.buckets));break;default:a.x=d3.scale.linear().range([0,t._width])}else a.x=d3.scale.linear().range([0,t._width]);if(t._config.yAxis&&t._config.yAxis.scale)switch(t._config.yAxis.scale){case"linear":a.y=d3.scale.linear().range([t._height,0]);break;case"time":a.y=d3.time.scale().range([t._height,0]);break;case"ordinal":a.y=d3.scale.ordinal().rangeBands([t._height,0],.1);break;case"quantile":a.y=d3.scale.ordinal().rangeBands([0,t._width],.1),a.q=d3.scale.quantile().range(d3.range(t._config.yAxis.buckets));break;default:a.y=d3.scale.linear().range([t._height,0])}else a.y=d3.scale.linear().range([t._height,0]);return a.color=d3.scale.category10(),a},getDomains:function(t){var a=this,e={},n=[],r="",s=function(t,a){return d3.ascending(t.y,a.y)},c=function(t,a){return d3.ascending(t.x,a.x)};if(a._config.data.sort&&a._config.data.sort.order)switch(a._config.data.sort.order){case"asc":s=function(t,a){return d3.ascending(t.y,a.y)},c=function(t,a){return d3.ascending(t.x,a.x)};break;case"desc":s=function(t,a){return d3.descending(t.y,a.y)},c=function(t,a){return d3.descending(t.x,a.x)}}if(a._config.xAxis&&a._config.xAxis.scale)switch(a._config.xAxis.scale){case"linear":n=d3.extent(t,function(t){return t.x}),e.x=n;break;case"time":break;case"ordinal":r=a._config.data.sort&&"y"===a._config.data.sort.axis?t.sort(s):t.sort(c),e.x=[],r.forEach(function(t){e.x.push(t.x)});break;case"quantile":r=a._config.data.sort&&"y"===a._config.data.sort.axis?t.sort(s):t.sort(c),e.q=[],r.forEach(function(t){e.q.push(t.x)}),e.x=d3.range(a._config.xAxis.buckets);break;default:n=d3.extent(t,function(t){return t.x}),e.x=n}else n=d3.extent(t,function(t){return t.x}),e.x=n;if(a._config.yAxis&&a._config.yAxis.scale)switch(a._config.yAxis.scale){case"linear":n=d3.extent(t,function(t){return t.y}),e.y=n;break;case"time":break;case"ordinal":if(a._config.data.sort&&"y"===a._config.data.sort.axis){var r=t.sort(function(t,a){return d3.ascending(t.y,a.y)});e.y=[],r.forEach(function(t){e.y.push(t.x)})}else e.y=d3.map(t,function(t){return t.y}).keys().sort(function(t,a){return d3.ascending(t,a)});break;default:n=d3.extent(t,function(t){return t.y}),e.y=n}else n=d3.extent(t,function(t){return t.y}),e.y=n;return e},destroy:function(){var t=this;d3.select(t._config.bindTo).html("")}},s.prototype=c.prototype={generate:function(){var t,a=this;a.draw(),a.setScales(),a.setAxes(),t=a._chart.loadData(),t.await(function(t,e){if(t)throw t;a.setData(e),a.setDomains(),a.drawAxes(),a.drawData(),a.draw45Line()})},draw:function(){var t=this;t._chart=r(t._config)},setScales:function(){var t=this;t._scales=t._chart.setScales()},setAxes:function(){var t=this;t._axes.x=d3.svg.axis().scale(t._scales.x).orient("bottom"),t._axes.y=d3.svg.axis().scale(t._scales.y).orient("left")},setData:function(t){var a=this;a._data=t},setDomains:function(){var t=this;t._scales.x.domain(d3.extent(t._data,function(t){return t.x})).nice(),t._scales.y.domain(d3.extent(t._data,function(t){return t.y})).nice()},drawAxes:function(){var t=this,a=t._chart._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+t._chart._height+")").call(t._axes.x);t._config.xAxis&&t._config.xAxis.text&&a.append("text").attr("class","label").attr("x",t._chart._width).attr("y",30).attr("x",470).style("text-anchor","end").text(t._config.xAxis.text);var e=t._chart._svg.append("g").attr("class","y axis").call(t._axes.y);t._config.yAxis&&t._config.yAxis.text&&e.append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",-40).attr("x",-100).attr("dy",".71em").style("text-anchor","end").text(t._config.yAxis.text)},draw45Line:function(){var t=this;t._chart._svg.append("line").attr("x1",t._scales.x(0)).attr("y1",t._scales.y(0)).attr("x2",t._scales.x(t._scales.x.domain()[1])).attr("y2",t._scales.y(t._scales.y.domain()[1])).style("stroke-dasharray","10,3").attr("stroke","#bbb")},drawData:function(){var t=this;t._chart._svg.selectAll(".dot").data(t._data,function(t){return t.key}).enter().append("circle").attr("class","dot").attr("r",3.5).attr("cx",function(a){return t._scales.x(a.x)}).attr("cy",function(a){return t._scales.y(a.y)}).style("fill",function(a){return t._scales.color(a.color)}).on("mouseover",function(a,e){t._config.data.mouseover.call(t,a,e),t._chart._tip.show(a,d3.select(this).node())}).on("mouseout",function(a,e){t._config.data.mouseout.call(this,a,e),t._chart._tip.hide()}).on("click",function(a,e){t._config.data.onclick.call(this,a,e)})},select:function(t){var a=this;a._chart._svg.selectAll("circle").data(a._data).attr("r",function(e){return e.x===t||e.y===t||e.z===t?(a._chart._tip.show(e,d3.select(this).node()),10):3.5}).style("fill","#ccc").style("cursor","pointer")},redraw:function(t){var a=this;a._chart.destroy(),a._config=t,a.generate()}},i.prototype=o.prototype={generate:function(){var t,a=this;a.draw(),a.setScales(),a.setAxes(),t=a._chart.loadData(),t.await(function(t,e){if(t)throw t;a.setData(e),a.setDomains(),a.drawAxes(),a.drawData()})},draw:function(){var t=this;t._chart=r(t._config)},setScales:function(){var t=this;t._scales.x=d3.time.scale().range([0,t._chart._width]),t._scales.y=d3.scale.linear().range([t._chart._height,0]),t._scales.color=d3.scale.category10()},setAxes:function(){var t=this;t._axes.x=d3.svg.axis().scale(t._scales.x).orient("bottom"),t._axes.y=d3.svg.axis().scale(t._scales.y).orient("left")},setData:function(t){var a=this,e=d3.keys(t[0]).filter(function(t){return"date"!==t}),n=e.map(function(a){return{name:a,values:t.map(function(t){return{x:t.date,y:+t[a]}})}});a._data=n},setDomains:function(){var t=this;t._scales.color.domain(t._data.map(function(t){return t.name})),t._scales.x.domain([d3.min(t._data,function(t){return d3.min(t.values,function(t){return t.x})}),d3.max(t._data,function(t){return d3.max(t.values,function(t){return t.x})})]),t._scales.y.domain([d3.min(t._data,function(t){return d3.min(t.values,function(t){return t.y})}),d3.max(t._data,function(t){return d3.max(t.values,function(t){return t.y})})])},drawAxes:function(){var t=this;t._chart._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+t._chart._height+")").call(t._axes.x).append("text").attr("class","label").attr("x",t._chart._width).attr("y",-6).style("text-anchor","end").text("Time"),t._chart._svg.append("g").attr("class","y axis").call(t._axes.y).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("")},drawData:function(){var t=this,a=d3.svg.line().interpolate("basis").x(function(a){return t._scales.x(a.x)}).y(function(a){return t._scales.y(a.y)}),e=t._chart._svg.selectAll(".series").data(t._data).enter().append("g").attr("class","series");e.append("path").attr("class","line").attr("d",function(t){return a(t.values)}).style("stroke",function(a){return t._scales.color(a.name)}),e.append("text").datum(function(t){return{name:t.name,value:t.values[t.values.length-1]}}).attr("transform",function(a){return"translate("+t._scales.x(a.value.x)+","+t._scales.y(a.value.y)+")"}).attr("x",3).attr("dy",".35em").text(function(t){return t.name})}},l.prototype=u.prototype={generate:function(){var t,a=this;a.draw(),a.setScales(),a.setAxes(),t=a._chart.loadData(),t.await(function(t,e){if(t)throw t;a.setData(e),a.drawData()})},select:function(t){return d3.selectAll(".layer").data(t)},draw:function(){var t=this;t._chart=r(t._config)},setScales:function(){var t=this;t._scales.x=d3.scale.ordinal().rangePoints([0,t._chart._width]),t._scales.y=d3.scale.linear().range([t._chart._height,0]),t._config.colorScale&&(t._scales.color=t._config.colorScale),t._config.colorScale||(t._scales.color=d3.scale.category20())},setAxes:function(){var t=this;t._axes.x=d3.svg.axis().scale(t._scales.x).orient("bottom"),t._axes.y=d3.svg.axis().scale(t._scales.y).orient("left")},setData:function(t){var a=this;a._data=t},setDomains:function(){var t=this;t._scales.x.domain(t._data.map(function(t){return t.x})),t._scales.y.domain([0,d3.max(t._data,function(t){return t.y0+t.y})]),t._config.percentage&&t._scales.y.domain([0,100])},drawAxes:function(){var t=this;t._chart._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+t._chart._height+")").call(t._axes.x).append("text").attr("class","label").attr("x",t._chart._width).attr("y",-6).style("text-anchor","end"),t._chart._svg.append("g").attr("class","y axis").call(t._axes.y).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end")},drawData:function(){var t=this,a=d3.nest().key(function(t){return t.x}).rollup(function(t){return d3.sum(t,function(t){return t.y})}).entries(t._data),e=d3.layout.stack().offset("zero").values(function(t){return t.values}).x(function(t){return t.x}).y(function(t){return t.y}),n=d3.nest().key(function(t){return t.key}),r=d3.svg.area().interpolate("monotone").x(function(a){return t._scales.x(a.x)}).y0(function(a){return t._scales.y(a.y0)}).y1(function(a){return t._scales.y(a.y0+a.y)});if(t._config.percentage)var r=d3.svg.area().interpolate("monotone").x(function(a){return t._scales.x(a.x)}).y0(function(e){return t._scales.y(100*e.y0/d(a,e.x+"").values)}).y1(function(e){return t._scales.y(100*(e.y0+e.y)/d(a,e.x+"").values)});var s=e(n.entries(t._data));t.setDomains(),t.drawAxes(),t._chart._svg.selectAll(".layer").data(s,function(t){return t.key}).enter().append("path").attr("class","layer").attr("d",function(t){return r(t.values)}).style("fill",function(a,e){return t._scales.color(e)}).on("click",function(a,e){t._config.data.onclick.call(this,a,e)}).on("mouseover",function(a,e){t._config.data.onmouseover.call(this,a,e)}).on("mouseout",function(a,e){t._config.data.onmouseout.call(this,a,e)})}},_.prototype.draw=function(){var t=this;t._chart._svg.selectAll(".bar").data(t._data).enter().append("rect").attr("class","bar").attr("x",function(a){return t._scales.x(a.x)}).attr("width",t._scales.x.rangeBand()).attr("y",function(a){return t._scales.y(a.y)}).attr("height",function(a){return t._chart._height-t._scales.y(a.y)}).on("mouseover",function(a,e){t._config.data.mouseover.call(t,a,e)})},g.prototype.draw=function(){var t=this;t._chart._svg.selectAll(".dot").data(t._data).enter().append("circle").attr("class","dot").attr("r",3.5).attr("cx",function(a){return t._scales.x(a.x)+t._scales.x.rangeBand()/2}).attr("cy",function(a){return t._scales.y(a.y)}).style("fill",function(a){return t._scales.color(a.color)}).on("mouseover",function(a,e){t._config.data.mouseover.call(t,a,e)}).on("mouseover",function(a){t._chart._tip.show(a,d3.select(this).node())}).on("mouseout",t._chart._tip.hide),t._chart._svg.selectAll("line.stem").data(t._data).enter().append("line").classed("stem",!0).attr("x1",function(a){return t._scales.x(a.x)+t._scales.x.rangeBand()/2}).attr("x2",function(a){return t._scales.x(a.x)+t._scales.x.rangeBand()/2}).attr("y1",function(a){return t._scales.y(a.y)}).attr("y2",t._chart._height).attr("stroke","#7A7A7A"),t._chart._svg.selectAll("circle").data(t._data).enter().append("circle").attr("cx",function(a){return t._scales.x(a.x)}).attr("cy",function(a){return t._scales.y(a.y)}).attr("r",6).attr("fill","#ccc").style("cursor","pointer")},g.prototype.select=function(t){var a=this;a._chart._svg.selectAll("circle").data(a._data).attr("r",function(e){return e.x===t||e.y===t?(a._chart._tip.show(e,d3.select(this).node()),10):3.5}).style("fill","#ccc").style("cursor","pointer")},h.prototype.draw=function(){var t=this;t._chart._svg.selectAll(".dot").data(t._data).enter().append("circle").attr("class","dot").attr("r",3.5).attr("cx",function(a){return console.log("X",a.x,t._scales.q(a.x)),t._scales.x(t._scales.q(a.x))+t._scales.x.rangeBand()/2}).attr("cy",function(a){return t._scales.y(a.y)}).style("fill",function(a){return t._scales.color(a.color)}).on("mouseover",function(a,e){t._config.data.mouseover.call(t,a,e)}),t._chart._svg.selectAll("circle").data(t._data).enter().append("circle").attr("cx",function(a){return t._scales.x(a.x)}).attr("cy",function(a){return t._scales.y(a.y)}).attr("r",6).attr("fill","#ccc").style("cursor","pointer")},h.prototype.renameAxis=function(t){t.selectAll("text").text("Marco rules!!!!!")},p.prototype.draw=function(){var t=this;t._chart._svg.selectAll("line.avg-line").remove(),t._config.plotOptions&&t._config.plotOptions.bars&&Array.isArray(t._config.plotOptions.bars.averageLines)&&t._config.plotOptions.bars.averageLines.length>0&&(t._chart._svg.selectAll("line.avg-line").data(t._config.plotOptions.bars.averageLines).enter().append("line").attr("class",".avg-line").attr("x1",0).attr("x2",function(a){return t._chart._width}).attr("y1",function(a){return t._scales.y(a.data.raw)}).attr("y2",function(a){return t._scales.y(a.data.raw)}).attr("stroke",function(t){return t.color}).attr("stroke-width",function(t){var a="3px";return t.strokeWidth&&(a=t.strokeWidth),a}).style("display",function(t){return t.enabled?"block":"none"}),t._chart._svg.selectAll("text.avg-line").data(t._config.plotOptions.bars.averageLines).enter().append("text").attr("class","avg-line").attr("x",t._chart._width).attr("y",function(a){return t._scales.y(a.data.raw)}).style("text-anchor","start").style("fill",function(t){return t.color}).style("font-size",function(t){var a="14px";return t.fontSize&&(a=t.fontSize),a}).text(function(t){return t.data.raw}).style("display",function(t){return t.enabled?"block":"none"}))},m.prototype=w.prototype={generate:function(){var t,a=this;a.init(),a.setScales(),a.setAxes(),t=a._chart.loadData(),t.awaitAll(function(t,e){if(t)throw t;a.setData(e),a.setDomains(),a.drawAxes(),a.drawData(),a._chart.dispatch.load()})},init:function(){var t=this;t._chart=r(t._config),t._chart.dispatch.on("load.chart",t._config.events.load(t))},setScales:function(){var t=this;t._scales=t._chart.setScales()},setAxes:function(){var t=this;if(t._axes.x=d3.svg.axis().scale(t._scales.x).orient("bottom"),t._axes.y=d3.svg.axis().scale(t._scales.y).orient("left"),t._config.yAxis&&t._config.yAxis.ticks&&t._config.yAxis.ticks.enabled===!0&&t._config.yAxis.ticks.style)switch(t._config.yAxis.ticks.style){case"straightLine":t._axes.y.tickSize(-t._chart._width,0)}},setData:function(t){var a=this;Array.isArray(t)&&(a._data=t[0],t.length>1&&t.forEach(function(t,e){e>0&&a._config.plotOptions.bars.averageLines[e-1].data.cartodb&&(a._config.plotOptions.bars.averageLines[e-1].data.raw=t[0].avg)}))},setDomains:function(){var t=this,a=t._chart.getDomains(t._data);t._scales.x.domain(a.x),t._scales.y.domain(a.y),t._scales.q&&(t._scales.q.domain(a.q),console.log("Domain",t._scales.q.domain()),console.log("Range",t._scales.q.range()),console.log("Treshold",t._scales.q.quantiles()))},drawAxes:function(){var t=this,a={config:t._config,chart:t._chart,data:t._data,scales:t._scales},e=t._chart._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+t._chart._height+")").call(t._axes.x);if(e.selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(t){return"rotate(-65)"}),t._config.style)switch(t._config.style){case"quantilesAndCircles":null===t.quantilesAndCircles&&(t.quantilesAndCircles=y(a)),t.quantilesAndCircles.renameAxis(e)}t._config.xAxis&&t._config.xAxis.text&&e.append("text").attr("class","label").attr("x",t._chart._width).attr("y",-6).style("text-anchor","end").text(t._config.xAxis.text);var n=t._chart._svg.append("g").attr("class","y axis").call(t._axes.y);t._config.yAxis&&t._config.yAxis.text&&n.append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(t._config.yAxis.text)},drawData:function(){var t=this,a={config:t._config,chart:t._chart,data:t._data,scales:t._scales};if(t._config.style)switch(t._config.style){case"lineAndCircles":null===t.quantilesAndCircles&&(t.lineAndCircles=x(a)),t.lineAndCircles.draw();break;case"columns":null===t.quantilesAndCircles&&(t.columns=f(a)),t.columns.draw();break;case"quantilesAndCircles":null===t.quantilesAndCircles&&(t.quantilesAndCircles=y(a)),t.quantilesAndCircles.draw();break;default:null===t.quantilesAndCircles&&(t.columns=f(a)),t.columns.draw()}t.averageLines=v(a),t.averageLines.draw()},set:function(t,a){var e=this;"config"===t?e._config=a:e._config[t]=a},select:function(t){var a=this;if(a._config.style)switch(a._config.style){case"lineAndCircles":null===a.lineAndCircles&&(a.lineAndCircles=x(params)),a.lineAndCircles.select(t);break;case"columns":null===a.columns&&(a.columns=f(params)),a.columns.draw();break;case"quantilesAndCircles":null===a.quantilesAndCircles&&(a.quantilesAndCircles=y(params)),a.quantilesAndCircles.draw();break;default:null===a.columns&&(a.columns=f(params)),a.columns.draw()}},redraw:function(){var t=this;t._chart.destroy(),t.generate()}},t.scatter=c,t.timeline=o,t.stackedArea=u,t.bars=w,Object.defineProperty(t,"__esModule",{value:!0})});