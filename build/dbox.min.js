!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.dbox=t.dbox||{})}(this,function(t){"use strict";function e(){function t(){}return t.query=function(t,e){var n=new cartodb.SQL({user:t.cartodb.user});n.execute(t.cartodb.sql).done(function(n){var i=n.rows;t.parser&&(i=n.rows.map(t.parser)),e(null,i)}).error(function(t){e(t,null)})},t}function n(t){function n(t){var e=this;e._config=t?t:{},e._data=[],e._margin=e._config.size.margin?e._config.size.margin:{left:0,right:0,top:0,bottom:0},e._width=e._config.size.width?e._config.size.width-e._margin.left-e._margin.right:800,e._height=e._config.size.height?e._config.size.height-e._margin.top-e._margin.bottom:600,e._svg="",e._scales={},e._axes={},e.layers=[]}return n.prototype.config=function(t){var e=this;return e._config=t,e},n.prototype.data=function(t){var e=this;return e._config.data=t,e},n.prototype.layer=function(t,e){var n,i=this,r=e?e:i._config;if(void 0!==t||null!==t)return n=t(r),n.chart(i),i.layers.push(n),n},n.prototype.draw=function(){var t,e=this;e._scales=e.scales(),e._axes=e.axes(),t=e.loadData(),t.await(function(t,n){if(t)throw t;e._data=n,e.drawSVG(),e.drawAxes(),e.drawGraphs()})},n.prototype.scales=function(){var t=this,e={};if(t._config.xAxis&&t._config.xAxis.scale)switch(t._config.xAxis.scale){case"linear":e.x=d3.scaleLinear().range([0,t._width]);break;case"time":e.x=d3.scaleTime().range([0,t._width]);break;case"ordinal":e.x=d3.scaleOrdinal().rangeBands([0,t._width],.1);break;case"quantile":e.x=d3.scaleOrdinal().rangeBands([0,t._width],.1),e.q=d3.scaleQuantile().range(d3.range(t._config.xAxis.buckets));break;default:e.x=d3.scaleLinear().range([0,t._width])}else e.x=d3.scaleLinear().range([0,t._width]);if(t._config.yAxis&&t._config.yAxis.scale)switch(t._config.yAxis.scale){case"linear":e.y=d3.scaleLinear().range([t._height,0]);break;case"time":e.y=d3.scaleTime().range([t._height,0]);break;case"ordinal":e.y=d3.scaleOrdinal().rangeBands([t._height,0],.1);break;case"quantile":e.y=d3.scaleOrdinal().rangeBands([0,t._width],.1),e.q=d3.scaleQuantile().range(d3.range(t._config.yAxis.buckets));break;default:e.y=d3.scaleLinear().range([t._height,0])}else e.y=d3.scaleLinear().range([t._height,0]);return e.color=d3.scaleOrdinal(d3.schemeCategory10),e},n.prototype.axes=function(){var t=this,e={};if(e.x=d3.axisBottom(t._scales.x),e.y=d3.axisLeft(t._scales.y),t._config.yAxis&&t._config.yAxis.ticks&&t._config.yAxis.ticks.enabled===!0&&t._config.yAxis.ticks.style)switch(t._config.yAxis.ticks.style){case"straightLine":e.y.tickSize(-t._width,0)}return t._config.yAxis&&t._config.yAxis.ticks&&t._config.yAxis.ticks.format&&e.y.tickFormat(t._config.yAxis.ticks.format),e},n.prototype.loadData=function(){var t=this;if(t._config.data.tsv)var n=d3.queue().defer(d3.tsv,t._config.data.tsv);if(t._config.data.json)var n=d3.queue().defer(d3.json,t._config.data.json);if(t._config.data.csv)var n=d3.queue().defer(d3.csv,t._config.data.csv);if(t._config.data.raw)var n=d3.queue().defer(t.mapData,t._config.data.raw);if(t._config.data.cartodb)var n=d3.queue().defer(e.query,t._config.data);return t._config.plotOptions&&t._config.plotOptions.bars&&t._config.plotOptions.bars.averageLines&&Array.isArray(t._config.plotOptions.bars.averageLines)&&t._config.plotOptions.bars.averageLines.length>0&&t._config.plotOptions.bars.averageLines.forEach(function(t){t.data.cartodb&&n.defer(e.query,t.data)}),n},n.prototype.drawSVG=function(){var t=this;if(d3.select(t._config.bindTo).select("svg").remove(),d3.select(t._config.bindTo).html(""),t._config.template&&d3.select(t._config.bindTo).classed(t._config.template,!0),t._config.chart&&t._config.chart.title&&d3.select(t._config.bindTo).append("div").attr("class","chart-title").html(t._config.chart.title),t._config.legend&&t._config.legend.enable===!0&&"top"===t._config.legend.position){var e=d3.select(t._config.bindTo).append("div").attr("class","chart-legend-top"),n="";n+="<div style='background-color:#E2E2E1;text-align:center;height: 40px;margin: 0px 15px'>",t._config.legend.categories.forEach(function(t){n+="<div class='dbox-legend-category-title' style='margin:0 20px;'><span class='dbox-legend-category-color' style='background-color:"+t.color+";'> </span><span style='height: 10px;float: left;margin: 10px 5px 5px 5px;border-radius: 50%;'>"+t.title+"</span></div>"}),n+="</div>",e.html(n)}t._svg=d3.select(t._config.bindTo).append("svg").attr("width",t._width+t._margin.left+t._margin.right).attr("height",t._height+t._margin.top+t._margin.bottom).append("g").attr("transform","translate("+t._margin.left+","+t._margin.top+")"),t._config.data.tip&&t._svg.call(t._tip),t._config.chart&&t._config.chart.background&&t._config.chart.background.color&&d3.select(t._config.bindTo+" svg").style("background-color",t._config.chart.background.color);d3.select(t._config.bindTo).append("div").attr("class","chart-legend-bottom")},n.prototype.drawAxes=function(){var t,e,n=this;if((!n._config.xAxis||n._config.xAxis&&n._config.xAxis.enabled!==!1)&&(t=n._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+n._height+")").call(n._axes.x)),(!n._config.yAxis||n._config.yAxis&&n._config.yAxis.enabled!==!1)&&(e=n._svg.append("g").attr("class","y axis").call(n._axes.y)),n._config.xAxis&&n._config.xAxis.text&&t.append("text").attr("class","label title").attr("x",n._chart._width/2).attr("y",30).style("text-anchor","middle").text(n._config.xAxis.text),n._config.xAxis&&n._config.xAxis.dropdown&&n._config.xAxis.dropdown.enable===!0){var i=d3.select(n._config.bindTo).append("div").attr("class","dbox-xAxis-select").append("select").on("change",function(){n.updateAxis("x",this.value)});i.selectAll("option").data(n._config.xAxis.dropdown.options).enter().append("option").attr("value",function(t){return t.value}).text(function(t){return t.title}).property("selected",function(t){return t.selected})}if(n._config.yAxis&&n._config.yAxis.enabled!==!1&&n._config.yAxis&&n._config.yAxis.text&&e.append("text").attr("class","label title").attr("transform","rotate(-90)").attr("y",-30).attr("x",-150).attr("dy",".71em").style("text-anchor","end").text(n._config.yAxis.text),n._config.yAxis&&n._config.yAxis.dropdown&&n._config.yAxis.dropdown.enable===!0){var r=d3.select(n._config.bindTo).append("div").attr("class","dbox-yAxis-select").attr("style",function(){var t=-1*d3.select(n._config.bindTo).node().getBoundingClientRect().width/2+n._chart._margin.left/4,e=-1*d3.select(n._config.bindTo).node().getBoundingClientRect().height/2;return"transform: translate("+t+"px,"+e+"px) rotate(-90deg);"}).append("select").on("change",function(){n.updateAxis("y",this.value)});r.selectAll("option").data(n._config.yAxis.dropdown.options).enter().append("option").attr("value",function(t){return t.value}).text(function(t){return t.title}).property("selected",function(t){return t.selected})}},n.prototype.drawGraphs=function(){var t=this;t.layers.forEach(function(e){e.data(t._data).scales(t._scales).axes(t._axes).domains().draw()})},n.prototype.dispatch=d3.dispatch("load","change"),n.prototype.mapData=function(t,e){e(null,t)},n.prototype.getDomains=function(t){var e=this,n={},i=[],r="",a=function(t,e){return d3.ascending(t.y,e.y)},o=function(t,e){return d3.ascending(t.x,e.x)};if(e._config.data.sort&&e._config.data.sort.order)switch(e._config.data.sort.order){case"asc":a=function(t,e){return d3.ascending(t.y,e.y)},o=function(t,e){return d3.ascending(t.x,e.x)};break;case"desc":a=function(t,e){return d3.descending(t.y,e.y)},o=function(t,e){return d3.descending(t.x,e.x)}}if(e._config.xAxis&&e._config.xAxis.scale)switch(e._config.xAxis.scale){case"linear":i=d3.extent(t,function(t){return t.x}),n.x=i;break;case"time":i=d3.extent(t,function(t){return t.x}),n.x=i;break;case"ordinal":r=e._config.data.sort&&"y"===e._config.data.sort.axis?t.sort(a):t.sort(o),n.x=[],r.forEach(function(t){n.x.push(t.x)});break;case"quantile":r=e._config.data.sort&&"y"===e._config.data.sort.axis?t.sort(a):t.sort(o),n.q=[],r.forEach(function(t){n.q.push(t.x)}),n.x=d3.range(e._config.xAxis.buckets);break;default:i=d3.extent(t,function(t){return t.x}),n.x=i}else i=d3.extent(t,function(t){return t.x}),n.x=i;if(e._config.yAxis&&e._config.yAxis.scale)switch(e._config.yAxis.scale){case"linear":i=d3.extent(t,function(t){return t.y}),i[0]>0&&(i[0]=i[0]-.1*(i[1]-i[0])),n.y=i;break;case"time":i=d3.extent(t,function(t){return t.y}),n.y=i;break;case"ordinal":if(e._config.data.sort&&"y"===e._config.data.sort.axis){var r=t.sort(function(t,e){return d3.ascending(t.y,e.y)});n.y=[],r.forEach(function(t){n.y.push(t.x)})}else n.y=d3.map(t,function(t){return t.y}).keys().sort(function(t,e){return d3.ascending(t,e)});break;default:i=d3.extent(t,function(t){return t.y}),n.y=i}else i=d3.extent(t,function(t){return t.y}),n.y=i;return n},n.prototype.destroy=function(){var t=this;d3.select(t._config.bindTo).html("")},new n(t)}function i(t){function e(t){var e=this;e._config=t?t:{},e._data=[],e._scales={},e._axes={}}return e.prototype.x=function(t){var e=this;return e._config.x=t,e},e.prototype.y=function(t){var e=this;return e._config.y=t,e},e.prototype.color=function(t){var e=this;return e._config.color=t,e},e.prototype.end=function(){var t=this;return t._chart},e.prototype.chart=function(t){var e=this;return e._chart=t,e},e.prototype.data=function(t){var e=this;return e._data=t.map(function(t){var n={};return n.x=+t[e._config.x],n.y=+t[e._config.y],n.color=t[e._config.color],n}),e},e.prototype.scales=function(t){var e=this;return e._scales=t,e},e.prototype.axes=function(t){var e=this;return e._axes=t,e},e.prototype.domains=function(){var t=this,e=d3.extent(t._data,function(t){return t.x}),n=d3.extent(t._data,function(t){return t.y}),i=[0,0];return t._config.fixTo45?(e[1]>n[1]?i[1]=e[1]:i[1]=n[1],e[0]<n[0]?i[0]=e[0]:i[0]=n[0],t._scales.x.domain(i).nice(),t._scales.y.domain(i).nice()):(t._scales.x.domain(e).nice(),t._scales.y.domain(n).nice()),t},e.prototype.draw=function(){var t=this;console.log(t,t._scales,t._scales.y(6.3));t._chart._svg.selectAll(".dot").data(t._data).enter().append("circle").attr("class","dot").attr("r",5).attr("cx",function(e){return t._scales.x(e.x)}).attr("cy",function(e){return console.log(e,t._scales,t._scales.y(e.y)),t._scales.y(e.y)}).style("fill",function(e){return t._scales.color(e.color)}).on("mouseover",function(e,n){t._config.mouseover&&t._config.mouseover.call(t,e,n)}).on("mouseout",function(e,n){t._config.mouseout&&t._config.mouseout.call(this,e,n)}).on("click",function(e,n){t._config.onclick&&t._config.onclick.call(this,e,n)});return t},new e(t)}function r(t){function e(t){var e=this;e._config=t?t:{},e._data=[],e._scales={},e._axes={},e._line=d3.line().curve(d3.curveBasis).x(function(t){return e._scales.x(t.x)}).y(function(t){return e._scales.y(t.y)})}var n=d3.timeParse("%Y-%m-%d");return e.prototype.x=function(t){var e=this;return e._config.x=t,e},e.prototype.y=function(t){var e=this;return e._config.y=t,e},e.prototype.series=function(t){var e=this;return e._config.series=t,e},e.prototype.color=function(t){var e=this;return e._config.color=t,e},e.prototype.end=function(){var t=this;return t._chart},e.prototype.chart=function(t){var e=this;return e._chart=t,e},e.prototype.data=function(t){var e=this;return e._data=t.map(function(t){return t.x=n(t[e._config.x]),t.color=t[e._config.color],delete t[e._config.x],t}),e._lines=e._config.y?e._config.y:e._config.series,e._lines=e._lines.map(function(e){return{name:e,values:t.map(function(t){return{x:t.x,y:+t[e]}})}}),e},e.prototype.scales=function(t){var e=this;return e._scales=t,e},e.prototype.axes=function(t){var e=this;return e._axes=t,e},e.prototype.domains=function(){var t=this,e=d3.extent(t._data,function(t){return t.x}),n=[d3.min(t._lines,function(t){return d3.min(t.values,function(t){return t.y})}),d3.max(t._lines,function(t){return d3.max(t.values,function(t){return t.y})})];return t._scales.x.domain(e).nice(),t._scales.y.domain(n).nice(),t},e.prototype.draw=function(){var t=this,e=(t._chart._svg.selectAll(".lines").data(t._lines).enter().append("g").attr("class","lines"),t._chart._svg.selectAll(".lines").append("path").attr("class","line").attr("d",function(e){return console.log(e),console.log(t._line(e.values)),t._line(e.values)}).style("stroke",function(t){return"Airbus"==t.name?"rgb(000,255,000)":"#000"}));return e.each(function(t){t.totalLength=this.getTotalLength()}).attr("stroke-dasharray",function(t){return t.totalLength+" "+t.totalLength}).attr("stroke-dashoffset",function(t){return t.totalLength}).transition().duration(5e3).ease(d3.easeLinear).attr("stroke-dashoffset",0),t},new e(t)}function a(t){function e(t){var e=this;e._config=t?t:{},e._data=[],e._scales={},e._axes={},e._gridSize=Math.floor(e._config.size.width/24),e._legendElementWidth=2*e._gridSize,e._buckets=9,e._colors=["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],e._days=["Mo","Tu","We","Th","Fr","Sa","Su"],e._times=["1a","2a","3a","4a","5a","6a","7a","8a","9a","10a","11a","12a","1p","2p","3p","4p","5p","6p","7p","8p","9p","10p","11p","12p"],e._datasets=["data.tsv","data2.tsv"]}return e.prototype.x=function(t){var e=this;return e._config.x=t,e},e.prototype.y=function(t){var e=this;return e._config.y=t,e},e.prototype.color=function(t){var e=this;return e._config.color=t,e},e.prototype.end=function(){var t=this;return t._chart},e.prototype.chart=function(t){var e=this;return e._chart=t,e},e.prototype.data=function(t){var e=this;return e._data=t.map(function(t){var e={day:+t.day,hour:+t.hour,value:+t.value};return e}),e},e.prototype.scales=function(t){var e=this;return e._scales=t,e},e.prototype.axes=function(t){var e=this;return e._axes=t,e},e.prototype.domains=function(){var t=this,e=d3.extent(t._data,function(t){return t.x}),n=d3.extent(t._data,function(t){return t.y}),i=[0,0];return t._config.fixTo45?(e[1]>n[1]?i[1]=e[1]:i[1]=n[1],e[0]<n[0]?i[0]=e[0]:i[0]=n[0],t._scales.x.domain(i).nice(),t._scales.y.domain(i).nice()):(t._scales.x.domain(e).nice(),t._scales.y.domain(n).nice()),t},e.prototype.draw=function(){var t=this;t._dayLabels=t._chart._svg.selectAll(".dayLabel").data(t._days).enter().append("text").text(function(t){return t}).attr("x",0).attr("y",function(e,n){return n*t._gridSize}).style("text-anchor","end").attr("transform","translate(-6,"+t._gridSize/1.5+")").attr("class",function(t,e){return e>=0&&e<=4?"dayLabel mono axis axis-workweek":"dayLabel mono axis"}),t._timeLabels=t._chart._svg.selectAll(".timeLabel").data(t._times).enter().append("text").text(function(t){return t}).attr("x",function(e,n){return n*t._gridSize}).attr("y",0).style("text-anchor","middle").attr("transform","translate("+t._gridSize/2+", -6)").attr("class",function(t,e){return e>=7&&e<=16?"timeLabel mono axis axis-worktime":"timeLabel mono axis"});var e=d3.scaleQuantile().domain([0,t._buckets-1,d3.max(t._data,function(t){return t.value})]).range(t._colors);console.log(e.domain(),e(20));var n=t._chart._svg.selectAll(".hour").data(t._data,function(t){return t.day+":"+t.hour});n.append("title"),n.enter().append("rect").attr("x",function(e){return(e.hour-1)*t._gridSize}).attr("y",function(e){return(e.day-1)*t._gridSize}).attr("rx",4).attr("ry",4).attr("class","hour bordered").attr("width",t._gridSize).attr("height",t._gridSize).style("fill",t._colors[0]).transition().duration(3e3).ease(d3.easeLinear).style("fill",function(t){return e(t.value)}),n.select("title").text(function(t){return t.value}),n.exit().remove();var i=t._chart._svg.selectAll(".legend").data([0].concat(e.quantiles()),function(t){return t}),r=i.enter().append("g").attr("class","legend");return r.append("rect").attr("x",function(e,n){return console.log(t._legendElementWidth*n),t._legendElementWidth*n}).attr("y",t._config.size.height-2*t._config.size.margin.bottom).attr("width",t._legendElementWidth).attr("height",t._gridSize/2).style("fill",function(e,n){return t._colors[n]}),r.append("text").attr("class","mono").text(function(t){return"≥ "+Math.round(t)}).attr("x",function(e,n){return t._legendElementWidth*n}).attr("y",t._config.size.height-2*t._config.size.margin.bottom+t._gridSize),i.exit().remove(),t},new e(t)}function o(t){function e(t){var e=this;e._config=t?t:{},e._config._padding=4,e._config._colorScale=d3.scale.category20c(),e._data=[],e._scales={},e._axes={}}return e.prototype.end=function(){var t=this;return t._chart},e.prototype.size=function(t){var e=this;return e._config._size=t,e},e.prototype.colorScale=function(t){var e=this;return e._config._colorScale=t,e},e.prototype.padding=function(t){var e=this;return e._config._padding=t,e},e.prototype.nestBy=function(t){var e=this;return e._config._key=t,e},e.prototype.chart=function(t){var e=this;return e._chart=t,e},e.prototype.isValidStructure=function(t){var e=this;return("string"==typeof t.name||t.name instanceof String)&&Array.isArray(t.children)||("string"==typeof t.name||t.name instanceof String)&&Number(t[e._config._size])==t[e._config._size]},e.prototype.formatNestedData=function(t){var e=this;if(t.key?(t.name=t.key,delete t.key):e._config._key&&(t.name=t[e._config._key]),Array.isArray(t.values)){var n=[];t.values.forEach(function(t){n.push(e.formatNestedData(t))}),t.children=n,delete t.values}return t},e.prototype.data=function(t){var e=this;if(t)if(Array.isArray(t)&&t.length>0){if(!e.isValidStructure(t[0])){t.forEach(function(t){t[e._config._size]=+t[e._config._size]});try{if(!e._config._key)throw"nestBy() in layer was not configured";t=[e.formatNestedData(d3.nest().key(function(t){return t[e._config._key]}).entries(t)[0])]}catch(t){console.error(t)}}}else if(!e.isValidStructure(t))try{if(!t.key)throw"Property 'key' not found";if(t[e._config._size]!==Number(t[e._config._size]))throw"Value used for treemap rect size is not a number";t=[e.formatNestedData(t)]}catch(t){console.error(t)}return e._data=t,e},e.prototype.draw=function(){var t=this,e=d3.layout.treemap().padding(t._config._padding).size([t._chart._width,t._chart._height]).value(function(e){return e[t._config._size]}),n=t._chart._svg.data(t._config._data).selectAll("g").data(e.nodes).enter().append("g").attr("class","cell").attr("transform",function(t){return"translate("+t.x+","+t.y+")"});return n.append("rect").attr("width",function(t){return t.dx}).attr("height",function(t){return t.dy}).style("fill",function(e){return e.children?t._config._colorScale(e.name):null}),n.append("text").attr("x",function(t){return t.dx/2}).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.children?null:t.name}),t},new e(t)}function c(t){function e(t,e,n,i){this._mapConfig=t,this._circlesConfig=e,this._tipConfig=n?n:{},i&&(this._callbackClick=i.click?i.click:null,this._callbackOver=i.over?i.over:null,this._callbackOut=i.out?i.over:null),this._mapLayer=d3.select("#map-wrapper"),this._tip=d3.tip(),n?this._tip.attr("class","d3-tip "+n.classes).html(n.html):this._tip.attr("class","d3-tip").html("<span>I'm a Tip</span>"),this._zoom=d3.zoom().scaleExtent([1,5]).on("zoom",this.zoomed)}var n;return e.prototype.zoomed=function(){this._tip.hide(),this._mapLayer.attr("transform",d3.event.transform)},e.prototype.drawMap=function(t){this._mapLayer.call(this._zoom).call(tip),this._data=d3.nest().key(function(t){return t.inegi}).entries(t),this._data.forEach(function(t,e){n=t.values.length,t.values.forEach(this.drawCircle)})},e.prototype.drawCircle=function(t,e){var i,r,a,o,c,s,l=this._circlesConfig.minPadding?this._circlesConfig.minPadding:5;i=d3.select("#est_"+t.inegi).node().getBBox(),r=i.width,a=n>1?Math.floor(Math.random()*(r-l+1)+l)/4:0,r=i.height,o=n>1?Math.floor(Math.random()*(r-l+1)+l)/4:0,s=i.y+i.height/2,c=i.x+i.width/2;var d=this;mapLayer.append("circle").attr("cx",c+a).attr("cy",s+o).attr("r",this._circlesConfig.radius?this._circlesConfig.radius:2.5).style("fill","red").style("stroke","white").style("stroke-width","1px").on("click",function(){console.log(this,d),d.triggerClick()}).on("mouseover",function(){d.triggerOver(t)}).on("mouseout",function(){d.triggerOut(t)})},e.prototype.triggerClick=function(t){console.log("click",t),this._callbackClick&&this._callbackClick(t)},e.prototype.triggerOver=function(t){this._tip.show(t),this._callbackOver&&this._callbackOver(t)},e.prototype.triggerOut=function(t){this._tip.hide(),this._callbackOut&&this._callbackOut(t)},e.prototype.setTipHtml=function(t){this._tip.html(t)},e}t.chart=n,t.scatter=i,t.timeline=r,t.heatmap=a,t.treemap=o,t.mexicoMapRounded=c,Object.defineProperty(t,"__esModule",{value:!0})});